<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel='import' href='../bower_components/paper-dialog/paper-dialog.html' />
<link rel='import' href='../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html' />
<link rel='import' href='../bower_components/paper-dialog-lite/paper-dialog-lite.html' />
<link rel='import' href='../bower_components/isw-dialog/isw-dialog.html' />
<link rel='import' href='../bower_components/isw-dialog/isw-dialog-remote.html' />
<link rel='import' href='../bower_components/paper-fab/paper-fab.html' />
<link rel='import' href='../bower_components/paper-listbox/paper-listbox.html' />
<link rel='import' href='../bower_components/paper-item/paper-item.html' />
<link rel='import' href='../bower_components/paper-icon-button/paper-icon-button.html' />
<link rel='import' href='../bower_components/paper-dropdown-menu/paper-dropdown-menu.html' />
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/web-animations-js/web-animations-next.min.html" />
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/granite-qrcode-scanner/granite-qrcode-scanner.html">
<link rel="import" href="../bower_components/granite-qrcode-decoder/granite-qrcode-decoder.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="test-camera.html">


<dom-module id="product-list">
    <template>
        <style>
            google-map {
                height: 300px;
            }

            paper-dropdown-menu {
                width: 200px;
                margin-right: 20px;
            }
        </style>

        <!-- <app-location route="{{route}}" url-space-regex="^[[rootPath]]">
        </app-location> -->
        <vaadin-date-picker label="Дата покупки" value={{date}}>
        </vaadin-date-picker>
        <!--<paper-input value="{{nameShop}}" placeholder="Наименование"></paper-input>
        <paper-input value="{{descriptionShop}}" placeholder="Описание"></paper-input>
         <google-map fit-to-markers api-key="AIzaSyDFsX7B97xHnLZWGD97X6ZGV8H9ZKBiJek" latitude="53.195538" longitude="50.101783">
            <template is="dom-repeat" items="{{markers}}">
                <google-map-marker latitude="{{item.latitude}}" longitude="{{item.longitude}}" click-events="true" on-google-map-marker-click="markerClick">
                </google-map-marker>
            </template>
        </google-map> -->
        <paper-dropdown-menu label="Магазин">
            <paper-listbox slot="dropdown-content" selected="1" attr-for-selected="id" id="shopMenu">
                <template is='dom-repeat' items='{{shops}}'>
                    <paper-item id="[[item.id]]">
                        {{item.name}}: {{item.description}}
                    </paper-item>
                </template>
            </paper-listbox>
        </paper-dropdown-menu>

        <paper-listbox>
            <template is='dom-repeat' items='{{products}}'>
                <paper-item>
                    <div>
                        <span>{{item.nameProduct}} </span>
                    </div>
                    <!-- <div>
                        <span>{{item.weightProduct}} кг </span>
                    </div> -->
                    <div>
                        <span>{{item.countProduct}} шт </span>
                    </div>
                    <div>
                        <span>{{item.priceProduct}} руб</span>
                    </div>
                    <paper-icon-button icon='delete' class='flex-1' style='color: gray' on-click='deleteProduct'>
                    </paper-icon-button>
                </paper-item>
            </template>
        </paper-listbox>




        <paper-fab icon='add' style='position:absolute; bottom: 10px; right:24px' on-click='showQrScanDialog'>
        </paper-fab>

        <paper-fab icon='add' style='position:absolute; bottom: 60px; right:24px' on-click='showAddProductDialog'>
        </paper-fab>
        <paper-dialog id='addProductDialog'>
            <paper-input value='{{nameProduct }}' placeholder="Наименование"></paper-input>
            <!-- <paper-input value="{{weightProduct}}" placeholder="Вес"></paper-input> -->
            <paper-input value="{{countProduct}}" placeholder="Количество"></paper-input>
            <paper-input value="{{priceProduct}}" placeholder="Цена"></paper-input>
            <div class='buttons'>
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button on-click='addProduct'>Add</paper-button>
            </div>
        </paper-dialog>

        <paper-dialog id='qrScanDialog'>
            <paper-dialog-scrollable>
                    <paper-input id="input" value="{{data}}"></paper-input>
                    <granite-qrcode-scanner data="{{data}}" debug></granite-qrcode-scanner>
                    <div style="text-align:center; margin-top:1em;">Last decoded QR Code: [[data]]</div>
                <div class='buttons'>
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button on-click='sendRequest'>Add</paper-button>
                </div>
            </paper-dialog-scrollable>
        </paper-dialog>



        <button on-click="save">Save</button>

        <iron-ajax id="requestRepos" url="https://rest-fns-check.herokuapp.com/check/{{data}}"
            params='{"type":"all"}' heders='{"Access-Control-Allow-Origin": "*"}' handle-as="json" on-response="handleResponse"></iron-ajax>

    </template>
    <script>
        Polymer({
            is: "product-list",
            properties: {
                nameShop: {
                    type: String
                },
                descriptionShop: {
                    type: String
                },
                idShop: {
                    type: Number
                },
                date: {
                    type: Date
                },
                // markers: {
                //     type: Array,
                //     value: []
                // },
                products: {
                    type: Array,
                    value: []
                },
                shops: {
                    type: Array,
                    value: []
                },
                data: {
                    type: String,
                    value: "fggts"
                }
            },
            indexedDB: window.indexedDB || window.webkitIndexedDB ||
                window.mozIndexedDB || window.msIndexedDB,
            IDBTransaction: window.IDBTransaction || window.webkitIDBTransaction,
            db: null,
            ready: function () {
                this.initDb();
                this.getAllShops();
            },
            initDb: function () {
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    this.db = request.result;
                };
                request.onerror = function (evt) {
                    console.log("IndexedDB error: " + evt.target.errorCode);
                };
                request.onupgradeneeded = function (evt) {
                    var objectStore = evt.currentTarget.result.createObjectStore("shop", {
                        keyPath: "id",
                        autoIncrement: true
                    });
                    objectStore.createIndex("name", "name");
                    objectStore.createIndex("coordinates", ["longitude", "latitude"]);

                    var objectStore = evt.currentTarget.result.createObjectStore("productList", {
                        keyPath: "id",
                        autoIncrement: true
                    });
                    objectStore.createIndex("date_shop", ["date", "idShop"]);
                };
            },
            getAllShops: function () {
                this.shops = [];
                var db;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                var self = this;

                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    var cursors = objectStore.openCursor();
                    cursors.onsuccess = function (event) {
                        if (event.target.result) {
                            // self.push('markers', {
                            //     latitude: event.target.result.value["latitude"],
                            //     longitude: event.target.result.value["longitude"]
                            // });
                            self.push('shops', {
                                id: event.target.result.value["id"],
                                name: event.target.result.value["name"],
                                description: event.target.result.value["description"]
                            });
                            event.target.result['continue']();
                        }
                    };
                };
            },
            // markerClick: function (event) {
            //     var longitude = event.target.longitude;
            //     var latitude = event.target.latitude;

            //     var self = this;
            //     var db;
            //     var request = this.indexedDB.open("BestPriceDatabase", 1);
            //     request.onsuccess = function (evt) {
            //         db = request.result;
            //         var transaction = db.transaction("shop", 'readwrite');
            //         var objectStore = transaction.objectStore("shop");
            //         var index = objectStore.index("coordinates");
            //         var getShop = index.get([longitude, latitude]);

            //         getShop.onsuccess = function (evt) {
            //             self.nameShop = getShop.result.name;
            //             self.descriptionShop = getShop.result.description;
            //             self.idShop = getShop.result.id;
            //         };
            //     };
            // },
            showAddProductDialog: function () {
                this.$.addProductDialog.open();
            },
            showQrScanDialog: function () {
                this.$.qrScanDialog.open();
            },
            addProduct: function () {
                var nameProduct = this.nameProduct;
                // var weightProduct = this.weightProduct;
                var countProduct = this.countProduct;
                var priceProduct = this.priceProduct;

                this.nameProduct = "";
                // this.weightProduct = "";
                this.countProduct = "";
                this.priceProduct = "";

                this.push('products', {
                    nameProduct: nameProduct,
                    // weightProduct: weightProduct,
                    countProduct: countProduct,
                    priceProduct: priceProduct
                });

                this.$.addProductDialog.close();
                //this.updateTasks();
            },
            deleteProduct: function (e) {
                var item = e.model.item;
                var index = this.products.indexOf(item);
                this.splice('products', index, 1);
            },
            save: function (e) {
                var date = this.date;
                var db;
                var idShop = Number(this.$.shopMenu.selectedItem.getAttribute("id"));
                var self = this;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("productList", 'readwrite');
                    var objectStore = transaction.objectStore("productList");
                    objectStore.add({
                        date: date,
                        idShop: idShop,
                        products: self.products
                    });
                }
            },

            handleResponse: function (data) {
                var repos = data.detail.response;
                var i;
                for (i = 0; i < repos.items.length; i++) {
                    this.push('products', {
                        nameProduct: repos.items[i][0],
                        priceProduct: repos.items[i][1],
                        countProduct: repos.items[i][2]
                    });
                }
            },
            sendRequest: function () {
                this.$.qrScanDialog.close();
                this.$.requestRepos.generateRequest();
            },
            openQrScanner: function () {
                this.set('route.path', this.rootPath + 'test-camera');
            },

        })
    </script>
</dom-module>