<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html"><link rel="import" href="../bower_components/google-map/google-map.html"><link rel="import" href="../bower_components/google-map/google-map-marker.html"><link rel="import" href="../bower_components/iron-pages/iron-pages.html"><link rel="import" href="../bower_components/app-route/app-route.html"><link rel="import" href="../bower_components/paper-dialog/paper-dialog.html"><link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html"><link rel="import" href="../bower_components/paper-dialog-lite/paper-dialog-lite.html"><link rel="import" href="../bower_components/isw-dialog/isw-dialog.html"><link rel="import" href="../bower_components/isw-dialog/isw-dialog-remote.html"><link rel="import" href="../bower_components/paper-fab/paper-fab.html"><link rel="import" href="../bower_components/paper-listbox/paper-listbox.html"><link rel="import" href="../bower_components/paper-item/paper-item.html"><link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html"><link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/web-animations-js/web-animations-next.min.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/granite-qrcode-scanner/granite-qrcode-scanner.html"><link rel="import" href="../bower_components/granite-qrcode-decoder/granite-qrcode-decoder.html"><link rel="import" href="../bower_components/paper-toast/paper-toast.html"><link rel="import" href="shared-styles.html"><script src="../bower_components/jsqrcode/dist/jsqrcode.js"></script></head><body><dom-module id="product-list"><template><style>google-map{height:300px;}paper-dropdown-menu{width:200px;margin-right:20px;}.yellow-button{text-transform:none;color:#eeff41;}</style><vaadin-date-picker label="Дата покупки" value="{{date}}"></vaadin-date-picker><paper-dropdown-menu label="Магазин"><paper-listbox slot="dropdown-content" selected="1" attr-for-selected="id" id="shopMenu"><template is="dom-repeat" items="{{shops}}"><paper-item id="[[item.id]]">{{item.name}}: {{item.description}}</paper-item></template></paper-listbox></paper-dropdown-menu><paper-listbox><template is="dom-repeat" items="{{products}}"><paper-item><div><span>{{item.nameProduct}}</span></div><div><span>{{item.countProduct}} шт</span></div><div><span>{{item.priceProduct}} руб</span></div><paper-icon-button icon="delete" class="flex-1" style="color: gray" on-click="deleteProduct"></paper-icon-button></paper-item></template></paper-listbox><paper-fab icon="add" style="position:absolute; bottom: 10px; right:24px" on-click="showQrScanDialog"></paper-fab><paper-fab icon="add" style="position:absolute; bottom: 60px; right:24px" on-click="showAddProductDialog"></paper-fab><paper-dialog id="addProductDialog"><paper-input value="{{nameProduct }}" placeholder="Наименование"></paper-input><paper-input value="{{countProduct}}" placeholder="Количество"></paper-input><paper-input value="{{priceProduct}}" placeholder="Цена"></paper-input><div class="buttons"><paper-button dialog-dismiss="">Cancel</paper-button><paper-button on-click="addProduct">Add</paper-button></div></paper-dialog><paper-dialog id="qrScanDialog"><paper-dialog-scrollable><paper-input id="input" value="{{data}}"></paper-input><granite-qrcode-scanner data="{{data}}" debug=""></granite-qrcode-scanner><div style="text-align:center; margin-top:1em;">Last decoded QR Code: [[data]]</div><div class="buttons"><paper-button dialog-dismiss="">Cancel</paper-button><paper-button on-click="sendRequest">Add</paper-button></div></paper-dialog-scrollable></paper-dialog><paper-toast id="toast1" duration="0" text="This toast will stay opened until you close it, or open another toast."><paper-button on-click="closeNotification" class="yellow-button">Close now!</paper-button></paper-toast><button on-click="openNotification">Notify</button> <button on-click="save">Save</button><iron-ajax id="requestRepos" url="https://rest-fns-check.herokuapp.com/check/{{data}}" params="{&quot;type&quot;:&quot;all&quot;}" heders="{&quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;}" handle-as="json" on-response="handleResponse"></iron-ajax></template><script>Polymer({is:"product-list",properties:{nameShop:{type:String},descriptionShop:{type:String},idShop:{type:Number},date:{type:Date},products:{type:Array,value:[]},shops:{type:Array,value:[]},data:{type:String,value:"fggts"}},indexedDB:window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,IDBTransaction:window.IDBTransaction||window.webkitIDBTransaction,db:null,ready:function(){this.initDb(),this.getAllShops()},initDb:function(){var a=this.indexedDB.open("BestPriceDatabase",1);a.onsuccess=function(){this.db=a.result},a.onerror=function(a){console.log("IndexedDB error: "+a.target.errorCode)},a.onupgradeneeded=function(a){var b=a.currentTarget.result.createObjectStore("shop",{keyPath:"id",autoIncrement:!0});b.createIndex("name","name"),b.createIndex("coordinates",["longitude","latitude"]);var b=a.currentTarget.result.createObjectStore("productList",{keyPath:"id",autoIncrement:!0});b.createIndex("date_shop",["date","idShop"])}},getAllShops:function(){this.shops=[];var a,b=this.indexedDB.open("BestPriceDatabase",1),c=this;b.onsuccess=function(){a=b.result;var d=a.transaction("shop","readwrite"),e=d.objectStore("shop"),f=e.openCursor();f.onsuccess=function(a){a.target.result&&(c.push("shops",{id:a.target.result.value.id,name:a.target.result.value.name,description:a.target.result.value.description}),a.target.result["continue"]())}}},showAddProductDialog:function(){this.$.addProductDialog.open()},showQrScanDialog:function(){this.$.qrScanDialog.open()},addProduct:function(){var a=this.nameProduct,b=this.countProduct,c=this.priceProduct;this.nameProduct="",this.countProduct="",this.priceProduct="",this.push("products",{nameProduct:a,countProduct:b,priceProduct:c}),this.$.addProductDialog.close()},deleteProduct:function(a){var b=a.model.item,c=this.products.indexOf(b);this.splice("products",c,1)},save:function(){var a,b=this.date,c=+this.$.shopMenu.selectedItem.getAttribute("id"),d=this,e=this.indexedDB.open("BestPriceDatabase",1);e.onsuccess=function(){a=e.result;var f=a.transaction("productList","readwrite"),g=f.objectStore("productList");g.add({date:b,idShop:c,products:d.products})}},handleResponse:function(a){var b,c=a.detail.response;for(b=0;b<c.items.length;b++)this.push("products",{nameProduct:c.items[b][0],priceProduct:c.items[b][1],countProduct:c.items[b][2]})},sendRequest:function(){this.$.qrScanDialog.close(),this.$.requestRepos.generateRequest()},openQrScanner:function(){this.set("route.path",this.rootPath+"test-camera")},openNotification:function(){this.$.toast1.open()},closeNotification:function(){this.$.toast1.toggle()}});</script></dom-module></body></html>