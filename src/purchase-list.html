<html><head><link rel="lazy-import" href="product-list.html"></head><body><dom-module id="purchase-list"><template><app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location><paper-input placeholder="Наименование"></paper-input><paper-listbox><template is="dom-repeat" items="{{purchases}}"><paper-item><div><span>{{item.date}}</span></div><div><span>{{item.shopName}}</span></div><div><span>{{item.sum}} руб</span></div></paper-item></template></paper-listbox><button on-click="add">Add</button></template><script>Polymer({is:"purchase-list",properties:{purchases:{type:Array,value:[]},rootPath:{type:String}},indexedDB:window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,IDBTransaction:window.IDBTransaction||window.webkitIDBTransaction,db:null,ready:function(){this.initDb(),this.getAllPurchases()},initDb:function(){var a=this.indexedDB.open("BestPriceDatabase",1);a.onsuccess=function(){this.db=a.result},a.onerror=function(a){console.log("IndexedDB error: "+a.target.errorCode)},a.onupgradeneeded=function(a){var b=a.currentTarget.result.createObjectStore("shop",{keyPath:"id",autoIncrement:!0});b.createIndex("name","name"),b.createIndex("coordinates",["longitude","latitude"]);var b=a.currentTarget.result.createObjectStore("productList",{keyPath:"id",autoIncrement:!0});b.createIndex("date_shop",["date","idShop"])}},getAllPurchases:function(){this.purchases=[];var a,b=this.indexedDB.open("BestPriceDatabase",1),c=this;b.onsuccess=function(){a=b.result;var d=a.transaction("productList","readwrite"),e=d.objectStore("productList"),f=e.openCursor();f.onsuccess=function(a){if(a.target.result){var b,d=a.target.result.value,e=a.target.result.value.products,f=0;for(b=0;b<e.length;b++)f+=+e[b].priceProduct;var g=a.target.result.value.idShop;c.getShop(g,a.target.result.value.id,a.target.result.value.date,f),a.target.result["continue"]()}}}},getShop:function(a,b,c,d){var e,a=a,f=this,g=this.indexedDB.open("BestPriceDatabase",1);g.onsuccess=function(){e=g.result;var h=e.transaction("shop","readwrite"),i=h.objectStore("shop"),j=i.get(a);j.onsuccess=function(){shopName=j.result.name+" "+j.result.description,f.push("purchases",{id:b,shopName:shopName,date:c,sum:d})}}},showAddProductDialog:function(){this.$.addProductDialog.open()},addProduct:function(){var a=this.nameProduct,b=this.countProduct,c=this.priceProduct;this.nameProduct="",this.countProduct="",this.priceProduct="",this.push("products",{nameProduct:a,countProduct:b,priceProduct:c}),this.$.addProductDialog.close()},deleteProduct:function(a){var b=a.model.item,c=this.products.indexOf(b);this.splice("products",c,1)},save:function(){var a,b=this.date,c=this,d=this.indexedDB.open("BestPriceDatabase",1);d.onsuccess=function(){a=d.result;var e=a.transaction("productList","readwrite"),f=e.objectStore("productList");f.add({date:b,idShop:c.idShop,products:c.products})}},add:function(){this.set("route.path",this.rootPath+"product-list")}});</script></dom-module></body></html>