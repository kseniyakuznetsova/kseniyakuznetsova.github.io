<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/google-map/google-map.html">
<link rel="import" href="../bower_components/google-map/google-map-marker.html">
<link rel="import" href="shared-styles.html">

<dom-module id="shop-list">
    <template>
        <style>
            google-map {
                height: 300px;
            }
        </style>
        <h1> Hello [[nameShop]]</h1>
        <google-map fit-to-markers api-key="AIzaSyDFsX7B97xHnLZWGD97X6ZGV8H9ZKBiJek" latitude="53.195538" longitude="50.101783">
            <google-map-marker latitude="{{latitude}}" longitude="{{longitude}}" draggable="true"></google-map-marker>
        </google-map>
        <paper-input bind-value="{{nameShop}}" value="{{nameShop}}" placeholder="Наименование"></paper-input>
        <paper-input id="input" bind-value="{{descriptionShop}}" value="{{descriptionShop}}" placeholder="Описание"></paper-input>
        <paper-input id="input" value="{{searchString}}" placeholder="Строка"></paper-input>
        <button on-click="filter">Filter</button>
        <button on-click="getAllShops">Get data</button>
        <button on-click="addShop">Add data</button>
        <google-map fit-to-markers api-key="AIzaSyDFsX7B97xHnLZWGD97X6ZGV8H9ZKBiJek" latitude="53.195538" longitude="50.101783">
            <template is="dom-repeat" items="{{markers}}">
                <google-map-marker latitude="{{item.latitude}}" longitude="{{item.longitude}}"> </google-map-marker>
            </template>
        </google-map>
        <template is="dom-repeat" items="{{shops}}" id="shopList">
            <div>Name:
                <span>{{item.name}}</span>
            </div>
            <div>Description:
                <span>{{item.description}}</span>
            </div>
            <button on-click="delete">x</button>
            <button on-click="update">update</button>
        </template>
    </template>
    <script>
        Polymer({
            is: "shop-list",
            properties: {
                nameShop: {
                    type: String
                },
                descriptionShop: {
                    type: String
                },
                shops: {
                    type: Array,
                    value: []
                },
                markers: {
                    type: Array,
                    value: []
                },
                searchString: {
                    type: String
                },
                longitude: {
                    type: Number,
                    value: 50.101783
                },
                latitude: {
                    type: Number,
                    value: 53.195538
                }
            },
            indexedDB: window.indexedDB || window.webkitIndexedDB ||
                window.mozIndexedDB || window.msIndexedDB,
            IDBTransaction: window.IDBTransaction || window.webkitIDBTransaction,
            db: null,
            ready: function () {
                this.initDb();
                this.getAllShops();
            },
            initDb: function () {
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    this.db = request.result;
                };
                request.onerror = function (evt) {
                    console.log("IndexedDB error: " + evt.target.errorCode);
                };
                request.onupgradeneeded = function (evt) {
                    var objectStore = evt.currentTarget.result.createObjectStore("shop",
                        { keyPath: "id", autoIncrement: true });
                    objectStore.createIndex("name", "name");
                    objectStore.createIndex("coordinates", ["longitude","latitude"]);

                    var objectStore = evt.currentTarget.result.createObjectStore("productList",
                        { keyPath: "id", autoIncrement: true });
                    objectStore.createIndex("date_shop", ["date", "idShop"]);
                };
            },
            addShop: function () {
                var description = this.descriptionShop;
                var name = this.nameShop;
                var db;
                var longitude = this.longitude;
                var latitude = this.latitude;
                var self = this;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    objectStore.add({ name: name, description: description, longitude: longitude, latitude: latitude });
                    self.getAllShops();
                }
            },
            getData: function () {
                var name = this.nameShop;
                var db;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    var index = objectStore.index("name");
                    var getBob = index.get(name);

                    getBob.onsuccess = function () {
                        this.descriptionShop = "111";
                        console.log(this.descriptionShop);
                    };
                };
            },
            getAllShops: function () {
                this.shops = [];
                var db;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                var self = this;

                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    var cursors = objectStore.openCursor();
                    cursors.onsuccess = function (event) {
                        if (event.target.result) {
                            self.push('shops', { id: event.target.result.value["id"], name: event.target.result.value["name"], description: event.target.result.value["description"] });
                            self.push('markers', { latitude: event.target.result.value["latitude"], longitude: event.target.result.value["longitude"] });
                            event.target.result['continue']();
                        }
                    };
                    console.log(self.markers);
                };
            },
            delete: function (e) {
                var item = this.$.shopList.itemForElement(e.target);
                var description = this.descriptionShop;
                var name = this.nameShop;
                var db;
                var self = this;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    objectStore.delete(item.id);
                    self.getAllShops();
                }
            },
            update: function (e) {
                var item = this.$.shopList.itemForElement(e.target);
                var description = this.descriptionShop;
                var name = this.nameShop;
                var db;
                var self = this;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readwrite');
                    var objectStore = transaction.objectStore("shop");
                    item.name = self.nameShop;
                    item.description = self.descriptionShop;
                    objectStore.put(item);
                    self.getAllShops();
                }
            },
            filter: function () {
                this.shops = [];
                var db;
                var request = this.indexedDB.open("BestPriceDatabase", 1);
                var self = this;

                request.onsuccess = function (evt) {
                    db = request.result;
                    var transaction = db.transaction("shop", 'readonly');
                    var objectStore = transaction.objectStore("shop");
                    var index = objectStore.index("name");
                    if (self.searchString == null) {
                        var cursors = objectStore.openCursor();
                        cursors.onsuccess = function (event) {
                            if (event.target.result) {
                                self.push('shops', { id: event.target.result.value["id"], name: event.target.result.value["name"], description: event.target.result.value["description"] });
                                event.target.result['continue']();
                            }
                        };
                    }
                    else {
                        var cursors = index.openCursor(IDBKeyRange.bound(self.searchString, self.searchString + '\uffff', true, true));
                        cursors.onsuccess = function (event) {
                            if (event.target.result) {
                                self.push('shops', { id: event.target.result.value["id"], name: event.target.result.value["name"], description: event.target.result.value["description"] });
                                event.target.result['continue']();
                            }
                        };
                    }

                };
            }
        })
    </script>
</dom-module>